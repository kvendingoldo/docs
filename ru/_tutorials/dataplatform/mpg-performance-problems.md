# Поиск проблем с производительностью кластера {{ mpg-name }}

Если возникли проблемы с производительностью кластера {{ mpg-name }}, проведите его диагностику. Так вы узнаете, что вызвало проблемы, и сможете их предотвратить в будущем.

Для поиска проблем и их причин есть несколько инструментов, которые показывают состояние кластера. Их важно использовать в совокупности, так как часто возникает не одна, а несколько аномалий.

В качестве примера предположим, что в кластере {{ mpg-name }} было повышенное потребление CPU. Чтобы понять, почему возникла проблема:

1. [Проверьте состояние кластера с помощью {{ monitoring-full-name }}](#monitoring).
1. [Диагностируйте производительность кластера](#performance-diagnostics).
1. [Посмотрите логи кластера](#logs).

После этого вы можете [оптимизировать работу кластера](../../managed-postgresql/tutorials/profiling.md) и снизить риск повтора проблемы.

## Проверьте состояние кластера с помощью {{ monitoring-full-name }} {#monitoring}

1. Перейдите на [страницу каталога]({{ link-console-main }}) и выберите сервис **{{ ui-key.yacloud.iam.folder.dashboard.label_managed-postgresql }}**.
1. Нажмите на имя нужного кластера и выберите вкладку **{{ ui-key.yacloud.postgresql.cluster.switch_monitoring }}**.
1. {% include [open-in-yandex-monitoring](../../_includes/mdb/open-in-yandex-monitoring.md) %}
1. На графике **Average CPU usage** найдите участок, где график постоянно рос, а потом вышел на плато.

   График показывает среднюю загрузку процессорных ядер. Плато на графике означает, что потребление CPU было выше нормы. Чтобы найти плато, отрегулируйте период, за который строятся графики.

1. Посмотрите другие графики. Найдите на них всплески или плато за тот же период, в котором было повышенное потребление CPU.

   Проверьте следующие графики:

   * **Session CPU usage cores** — показывает потребление CPU по видам сессий. В результате можно узнать, во время сессии какого пользователя и на какой БД CPU потреблялось выше нормы.

      Обычно пользователи вызывают высокое потребление CPU, когда выполняют длительные запросы (например, аналитические запросы без индексов для таблиц). Такие запросы можно отследить на графике **Age of oldest transaction/statement**.

   * **Age of oldest transaction/statement** — показывает длительность транзакций и запросов. Если на графике есть всплеск, значит, определенные запросы выполнялись дольше обычного.

      Допустим, всплеск на графике **Age of oldest transaction/statement** отображается за то же время, что и всплески или плато на графиках **Session CPU usage cores** и **Average CPU usage**. Это означает, что повышенное потребление CPU вызвали длительные запросы.

   1. (Опционально) Проверьте другие графики:

      * **Average transaction/statement time** — показывает среднее время, затраченное на выполнение транзакций и запросов. Если график возрастает, возможно, некоторые запросы стали выполняться дольше.

      * **Log errors** — показывает поток ошибок в кластере. Если на графике есть всплеск, проверьте логи кластера.

      * **OOM Count** — показывает наличие процессов Out-Of-Memory Killer. Они останавливают приложения, которые расходуют всю память на машине, и предотвращают аварийную остановку ОС. Если на графике **OOM Count** отображаются процессы Out-Of-Memory Killer, проверьте расход памяти в кластере на графике **Maximum memory usage** и освободите память для приложений.

      * **{{ PG }} Alive, [boolean]** — показывает доступность {{ PG }} на хостах кластера. Если вы не можете подключиться к какому-либо хосту кластера, проверьте его доступность на этом графике.

      * **Sessions per wait event** — количество ожидающих сессий по типам событий. К таким типам относятся, например, блокировки или ожидание, когда CPU или память освободятся. Если на графике есть всплеск, значит, в кластере заканчиваются ресурсы.

      * **Sessions read bytes** и **Sessions write bytes** — показывают объем прочитанных и записанных данных в разбивке по сессиям. Если объем упирается в лимит, работа кластера может замедлиться.

      * **Transactions/statements per second** — показывает количество запросов и транзакций в секунду. Если на кластер создана высокая нагрузка, график покажет, вызвана ли она большим количеством запросов. Если у кластера заканчиваются ресурсы, на графике отображается провал.

      Полный список графиков доступен в разделе [{#T}](../../managed-postgresql/operations/monitoring.md).

## Диагностируйте производительность кластера {#performance-diagnostics}

После того как вы выяснили, в какое время потребление CPU было повышенным, найдите запросы, которые привели к проблеме. Для этого воспользуйтесь [диагностикой производительности](../../managed-postgresql/operations/performance-diagnostics.md) в кластере {{ mpg-name }}:

1. [Включите опцию](../../managed-postgresql/operations/update.md#change-additional-settings) **{{ ui-key.yacloud.mdb.forms.field_diagnostics-enabled }}**, если она еще не включена.
1. На странице кластера выберите ![image](../../_assets/console-icons/heart-pulse.svg) **{{ ui-key.yacloud.postgresql.cluster.switch_diagnostics }}** на панели слева.
1. На открывшейся вкладке найдите участок, где график постоянно рос, а потом вышел на плато. Он должен совпадать по времени с теми же участками графиков, которые вы [нашли в {{ monitoring-full-name }}](#monitoring).

   Чтобы найти плато, отрегулируйте период, за который строятся графики.

1. На вкладке **{{ ui-key.yacloud.mdb.cluster.diagnostics.label_sessions }}**, в поле **Срез** выберите значение **WAIT_EVENT**.
1. Найдите события ожидания (wait events), из-за которых потребление CPU повысилось. Для этого наведите курсор на плато. Во всплывающем окне отобразятся все возможные события ожидания. На проблему преимущественно влияют события с наибольшими значениями.
1. В списке запросов под графиком найдите запросы, для которых отображается большое количество обнаруженных событий ожидания.

   Допустим, график показал много событий ожидания типа **CPU**. Тогда проблемные запросы также содержат большое количество таких событий. Это видно на диаграммах, расположенных в строках запросов в списке:

   ![image](../../_assets/managed-postgresql/statement-in-performance-diagnostics.jpeg)

В результате вы нашли запросы, которые вызвали повышенное потребление CPU.

## Посмотрите логи кластера {#logs}

Допустим, в {{ monitoring-full-name }}, на графике **Log errors** отображаются всплески. Чтобы узнать, что произошло, проверьте логи кластера. Их рекомендуется проверять ежедневно, не только в случае инцидентов. Так вы будете знать об актуальном состоянии кластера.

Чтобы посмотреть логи:

1. На странице кластера {{ mpg-name }} выберите ![image](../../_assets/console-icons/receipt.svg) **{{ ui-key.yacloud.postgresql.cluster.switch_logs }}** на панели слева.
1. Задайте период, за который было замечено повышенное потребление CPU.
1. В поле **{{ ui-key.yacloud.mdb.cluster.logs.label_severity }}** выберите **ERROR**, **PANIC** и **FATAL**.
1. Посмотрите полученный список ошибок. Они показывают, что происходило во время повышенного потребления CPU.

   Ошибка может отображаться в логах несколько раз. Например, если пользователь отправлял слишком длительные запросы, в логах может повторяться ошибка **canceling statement due to user request**. Это означает, что БД не смогла обработать запросы в ожидаемый промежуток времени, и поэтому они были отменены.

1. Смените уровень логирования на **LOG** и **WARNING**.
1. Посмотрите полученный список событий, которые происходили за заданный период.

   В логах отображаются запросы, которые были выполнены. Если в кластере [преднастроен](../../managed-postgresql/operations/update.md#change-postgresql-config) параметр СУБД [log_min_duration_statement](../../managed-postgresql/concepts/settings-list.md#setting-log-min-duration-statement), логи также показывают время выполнения запросов. В результате можно найти длительные запросы.

   {% note warning %}

   При нулевом значении параметра `log_min_duration_statement` в лог попадают все запросы независимо от времени их выполнения. Из-за этого свободное место в хранилище может быстро закончиться.

   {% endnote %}

   Логи типа **LOG** и **WARNING** содержат не только выполненные запросы. Например, в логах может быть запись **temporary file: path "<путь_к_файлу>" size <размер_файла>**. Многократный повтор такой записи показывает, что запросы составлены неоптимально. Их сортировка или агрегация потребляют слишком много памяти [work_mem]({{ pg-docs }}/runtime-config-resource.html#RUNTIME-CONFIG-RESOURCE-MEMORY), выделенной под выполнение операций в БД. В результате не хватает памяти в буфере кластера.

В результате вы определили, когда и почему возникло повышенное потребление CPU, какие пользователи и запросы вызвали его и какие события были связаны с этой проблемой. Чтобы в дальнейшем предотвратить повтор проблемы в кластере {{ mpg-name }}, [оптимизируйте его работу](../../managed-postgresql/tutorials/profiling.md).
