---
title: Рекомендации по настройке проверок состояния {{ alb-full-name }}
description: На странице представлены рекомендации по настройке проверок состояния {{ alb-name }}.
---

# Рекомендации по настройке проверок состояния {{ alb-full-name }}

Для [бэкендов](backend-group.md), состоящих из [целевых групп](target-group.md), рекомендуется настроить [проверки состояния](backend-group.md#health-checks). L7-балансировщик будет отправлять проверочные запросы к эндпоинтам через определенные промежутки времени и ожидать ответа в течение определенного периода. В зависимости от результатов проверки будет регулироваться подача трафика к конкретному эндпоинту.

## Преимущества {#health-checks-advantages}

### Высокая доступность приложений {#hight-availability}

Высокая доступность и надежность приложений зависят от правильно настроенных проверок состояния. Проверки позволяют своевременно исключить неработающие экземпляры приложения, оставив доступными только стабильные. А значит, пользователи будут реже сталкиваться с отказом вашего сервиса. Это улучшает пользовательский опыт и защищает от финансовых и репутационных рисков.

Проверка состояния выполняется так: L7-балансировщик периодически отправляет проверочные запросы к бэкендам, на которых развернуты и работают экземпляры приложений. Если в течение заданного времени ответа не поступает, балансировщик помечает бэкенд как неработоспособный и перенаправляет трафик на другие бэкенды. При этом балансировщик продолжает периодически отправлять проверочные запросы ко всем бэкендам. Если неработоспособный бэкенд восстанавливается и отвечает на запрос, он снова включается в работу.

Таким образом, проверки состояния помогают балансировщику правильно распределять нагрузку, определять доступные и восстановившиеся бэкенды и своевременно исключать вышедшие из строя.

### Бесшовное сервисное обслуживание {#service-maintenance}

Проверки состояния позволяют сохранить работоспособность приложения во время его последовательного обновления на бэкендах. Поскольку при обновлении ВМ может автоматически перезагружаться, в это время приложение будет недоступно. Благодаря проверкам состояния балансировщик вовремя отследит недоступный бэкенд и направит трафик на другие бэкенды. А после обновления трафик будет снова распределен на все бэкенды.

Таким образом, для пользователей обновление пройдет незаметно.

### Разумное распоряжение ресурсами {#resource-saving}

Проверки состояния помогают вовремя выявить сбой в приложении и устранить его. А значит избежать потерь простоя: не оплачивать ресурсы, которые на самом деле недоступны, не оказывают услуг пользователям и не приносят прибыли.

## Правила настройки {#health-checks-rules}

### Выделенный эндпойнт для проверки состояния {#health-checks-endpoint}

Включите в логику приложения на бэкенде отдельный эндпоинт, который будет отвечать на запросы проверок состояния.
Это нужно, чтобы не загружать дополнительными запросами эндпоинты, которые выполняют полезную работу — обрабатывают запросы пользователей. Запросы проверок состояния не должны влиять на работу приложения. Например, частые запросы не должны загружать базы данных или другие критические компоненты. 

При этом проверочный эндпоинт должен быть интегрирован с приложением, а не работать автономно. Работоспособность проверочного эндпойнта должна быть напрямую связана с работоспособностью приложения. Шифрование и протокол проверочного эндпоинта должны совпадать с рабочими эндпоинтами. Это позволит считать, что если проверочный эндпоинт не отвечает, то и весь бэкенд недоступен.

### Интеграция с Instance Groups {#instance-groups-integrations}

[Интеграция группы ВМ с L7-балансировщиком](../../compute/concepts/instance-groups/balancers.md) позволяет автоматически восстанавливать работоспособность приложений без участия администратора. Это возможно, поскольку группа может автоматически пересоздавать ВМ, на которую долгое время не поступает трафик с балансировщика. 

При настройке интеграции нужно указать параметр `max_opening_traffic_duration`. Это время, в течение которого новая ВМ в группе должна пройти проверку состояния от балансировщика.

### Режим паники {#panic-mode}

В некоторых случаях проверки состояния можно автоматически отключать, чтобы сохранить работоспособность приложения при резком росте нагрузки. Для этого предусмотрен [режим паники](backend-group.md#panic-mode). В этом режиме балансировщик будет распределять запросы на все эндпоинты, не учитывая результаты проверок состояния. Для некоторых пользователей сервис будет недоступен, но для других он будет работать.

Когда режим паники не используется, отказ части бэкендов вызовет рост нагрузки на еще работающие бэкенды. Если приложение работает на пределе возможностей, это приведет к отказу всех бэкендов и полной недоступности сервиса для всех пользователей.

## Практические рекомендации {#health-checks-recommendations}

Проверки состояния задаются при [создании группы бэкендов](../operations/backend-group-create.md). Для каждого бэкенда можно добавить одну или несколько проверок.

{% include [backend-healthcheck](../../_includes/application-load-balancer/backend-healthcheck.md) %}

При настройке проверки состояния можно оставить предложенные параметры по умолчанию или указать свои. Проверки состояния должны учитывать возможности бэкенда и не перегружать его. Например, если время ответа бэкенда более 1 секунды, то таймаут должен быть больше этого значения.

Ниже приведены оптимальные параметры, которые подойдут при первой настройке {{ alb-name }}. В дальнейшем вы можете скорректировать эти значения в зависимости от работы ваших бэкендов и L7-балансировщика.

  * **{{ ui-key.yacloud.alb.label_timeout }}** — `1`.
  * **{{ ui-key.yacloud.alb.label_interval }}** — `1`.
  * **{{ ui-key.yacloud.alb.label_healthy }}** — `2`.
  * **{{ ui-key.yacloud.alb.label_unhealthy }}** — `3`.


